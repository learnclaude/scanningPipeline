# Test Dockerfile for running tests in CI/CD pipelines
FROM node:18-alpine AS test

# Install dependencies for testing
RUN apk add --no-cache \
    libc6-compat \
    chromium \
    firefox-esr \
    harfbuzz \
    nss \
    freetype \
    ttf-freefont \
    && rm -rf /var/cache/apk/*

# Set Puppeteer/Playwright to use installed Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser \
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1 \
    PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

WORKDIR /app

# Copy package files
COPY package.json package-lock.json* ./

# Install all dependencies including devDependencies
RUN npm ci

# Skip Playwright system dependencies (use Alpine packages instead)
# RUN npx playwright install-deps

# Copy application code
COPY . .

# Create test user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S testuser -u 1001 -G nodejs

# Create directories for test outputs
RUN mkdir -p coverage test-results playwright-report && \
    chown -R testuser:nodejs coverage test-results playwright-report

# Set test environment
ENV NODE_ENV=test
ENV CI=true

# Switch to test user
USER testuser

# Default command runs all tests
CMD ["npm", "run", "test:all"]